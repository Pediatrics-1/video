<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî –ö–î–ë ‚Ññ1</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --brand:#0051A8;
    --bg:#F7FAFF;
    --panel:#ffffff;
    --text:#0F172A;
    --muted:#64748B;
    --line:#E2E8F0;
    --radius:18px;
    --shadow:0 10px 28px rgba(2,8,23,.06), 0 2px 10px rgba(2,8,23,.05);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}
  body{padding-bottom:64px}

  /* Header */
  header{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.9));
    backdrop-filter:saturate(180%) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:880px;margin:0 auto;padding:11px 15px}

  .header-row{display:flex; gap:12px; align-items:center}
.logo{
    width:50px; height:70px;
    display:grid; place-items:center;
    flex:0 0 auto;
    padding:4px;  /* —á—É—Ç—å –æ—Ç—Å—Ç—É–ø–∞ –≤–æ–∫—Ä—É–≥ –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
}
.logo img{
    width:100%;
    height:100%;
    object-fit:contain;
}


  .header-title{margin:0; font-weight:900; font-size:18px; line-height:1.35; letter-spacing:.1px; color:#0B2E5E}
  .header-sub{margin:4px 0 0; color:#0B2E5E; font-size:13px; font-weight:700}

  /* Blocks */
  .block{margin-top:12px; background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  .block-title{margin:0 0 10px; font-size:14px; font-weight:800; color:#0B2E5E; letter-spacing:.2px}

  /* Selector */
  .theme-select{display:grid; gap:8px}
  select{
    width:100%; padding:12px 14px;
    border:1px solid var(--line); border-radius:12px; background:#fff; color:#000; font:inherit;
    outline:none;
  }

  /* Topic Card */
  .card-title{font-size:24px; font-weight:900; margin:0 0 12px; line-height:1.2; letter-spacing:.2px; color:#0B2E5E}
  .player{width:100%; aspect-ratio:16/9; background:#000; border-radius:14px; overflow:hidden; border:1px solid var(--line)}
  .player iframe, .player video{width:100%; height:100%; display:block; border:0}

  /* Description (Markdown + safe HTML) */
  .desc{margin-top:12px}
  .desc p{margin:0 0 10px}
  .desc h1,.desc h2,.desc h3{margin:12px 0 8px}
  .desc ul{margin:8px 0 10px; padding-left:22px}
  .desc a{color:var(--brand); text-decoration:underline}

  /* Actions */
  .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff;
    padding:11px 14px; border-radius:12px; font-weight:800; display:inline-flex; align-items:center; gap:8px;
  }
  .btn.secondary{background:#fff; color:var(--brand)}
  .btn.disabled{opacity:.6; background:#e5ecf6; border-color:#e5ecf6; color:#6b7280; pointer-events:none}
  .like-count{display:inline-block; min-width:28px; padding:2px 8px; background:#fff; color:var(--brand); border-radius:999px; border:1px solid #cfe0f3; font-weight:800}

  /* Comments */
  .comments{margin-top:14px}
  .comment-list{display:grid; gap:10px}
  .comment{background:#E6F0FA;border:1px solid var(--line);border-radius:12px;padding:10px}
  .comment small{color:var(--muted); display:block; margin-top:6px}
  .empty{padding:10px;color:var(--muted);font-size:14px}

  form.comment-form{display:grid; gap:8px; margin-top:12px}
  input[type="text"], textarea{
    width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; color:#000; font:inherit
  }
  textarea{min-height:96px; resize:vertical}
  .status{margin-top:6px; font-size:14px; color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="header-row">
      <div class="logo">
        <img src="https://www.tajmedun.tj/bitrix/templates/tajmedun/images/logo_new2.png" alt="–õ–æ–≥–æ—Ç–∏–ø –¢–ì–ú–£">
      </div>
      <div>
        <h1 class="header-title">–ì–û–£ "–¢–ì–ú–£ –ò–ú–ï–ù–ò –ê–ë–£–ê–õ–ò –ò–ë–ù–ò –°–ò–ù–û"</h1>
        <p class="header-sub">–ö–∞—Ñ–µ–¥—Ä–∞ –¥–µ—Ç—Å–∫–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π ‚Ññ1 –∏–º–µ–Ω–∏ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ –ê–º–∏–Ω–æ–≤–∞ –•.–î–∂.</p>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- –¢–µ–º–∞—Ç–∏–∫–∞ -->
  <section class="block">
    <h2 class="block-title">–¢–µ–º–∞—Ç–∏–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ 4 –∫—É—Ä—Å–∞</h2>
    <div class="theme-select">
      <label for="topicSelect" style="font-size:13px; color:#334155">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</label>
      <select id="topicSelect" aria-label="–í—ã–±–æ—Ä —Ç–µ–º—ã"></select>
    </div>
  </section>

  <!-- –¢–µ–∫—É—â–∞—è —Ç–µ–º–∞ -->
  <section id="card" class="block" hidden>
    <h2 id="topicTitle" class="card-title"></h2>
    <div id="player" class="player"></div>
    <div id="desc" class="desc"></div>

    <div class="actions">
      <button id="likeBtn" class="btn" type="button">üëç –ù—Ä–∞–≤–∏—Ç—Å—è <span id="likeCount" class="like-count">0</span></button>
      <button id="shareBtn" class="btn secondary" type="button">‚Üó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <section class="comments" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">
  <h3 style="margin:10px 0 8px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>

  <!-- —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
  <div id="comments" class="comment-list">
    <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </div>

  <!-- —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
  <h4 style="margin:16px 0 8px; font-size:15px; font-weight:700; color:#334155;">–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h4>

  <!-- —Ñ–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ -->
  <form id="commentForm" class="comment-form">
    <input name="name" type="text" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
    <textarea name="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" required></textarea>
    <button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </form>
  <div id="commentMsg" class="status"></div>
</section>


  <p id="pageStatus" class="status" style="margin:12px 2px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º‚Ä¶</p>
</main>

<script>
/* ===== URL –≤–∞—à–µ–≥–æ Apps Script (‚Ä¶/exec) ===== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbzxGZVrxDXEJwKoBfWXWUJbJZWzgloRDvrb4aAeQUIgLJLRLVsQA7O69koTRJdeYpJs/exec'.trim();

/* ===== –†–∞–∑—Ä–µ—à–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ inline-—Ç–µ–≥–∏ –∏–∑ —è—á–µ–π–∫–∏ (span/b/strong/i/em/u/a) ===== */
function allowInlineHtml(input) {
  if (!input) return { text: '', placeholders: [] };
  const placeholders = [];
  const withPh = input.replace(/<(\/?)(span|b|strong|i|em|u|a)([^>]*)>/gi, (m, slash, tag, attrs) => {
    tag = tag.toLowerCase();
    let safe = '';

    if (slash) {
      safe = `</${tag}>`;
    } else {
      if (tag === 'a') {
        const hrefMatch = attrs.match(/href\s*=\s*"(.*?)"/i) || attrs.match(/href\s*=\s*'(.*?)'/i);
        const href = hrefMatch ? hrefMatch[1] : '';
        if (/^https?:\/\//i.test(href)) {
          safe = `<a href="${href.replace(/"/g,'&quot;')}" target="_blank" rel="noopener">`;
        } else {
          safe = '<a>';
        }
      } else if (tag === 'span') {
        const styleMatch = attrs.match(/style\s*=\s*"(.*?)"/i) || attrs.match(/style\s*=\s*'(.*?)'/i);
        let style = styleMatch ? styleMatch[1] : '';
        const allowed = [];
        style.split(';').forEach(rule => {
          const [kRaw, vRaw] = rule.split(':');
          if (!kRaw || !vRaw) return;
          const k = kRaw.trim().toLowerCase();
          const v = vRaw.trim();
          if (['color','background-color','font-weight','font-style','text-decoration','font-size'].includes(k)) {
            allowed.push(`${k}:${v}`);
          }
        });
        safe = allowed.length ? `<span style="${allowed.join(';')}">` : '<span>';
      } else {
        safe = `<${tag}>`;
      }
    }

    const ph = `@@TAG${placeholders.length}@@`;
    placeholders.push(safe);
    return ph;
  });

  const escaped = withPh
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');

  return { text: escaped, placeholders };
}

/* ===== Markdown ‚Üí HTML + –≤–æ–∑–≤—Ä–∞—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤ ===== */
function mdToHtml(md){
  const { text, placeholders } = allowInlineHtml(md || '');

  let out = text
    .replace(/^###\s+(.*)$/gm, '<h3>$1</h3>')
    .replace(/^##\s+(.*)$/gm, '<h2>$1</h2>')
    .replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');

  out = out.replace(/^(?:-\s+.+(?:\n|$))+?/gm, match=>{
    const items = match.trim().split(/\n/).map(l=>l.replace(/^-+\s+/,'').trim()).filter(Boolean);
    return '<ul>'+items.map(it=>'<li>'+it+'</li>').join('')+'</ul>';
  });

  out = out.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
           .replace(/\*([^*]+)\*/g, '<em>$1</em>');

  out = out.split(/\n{2,}/).map(p=>{
    if (/^<h\d|^<ul/.test(p.trim())) return p;
    return '<p>'+p.trim().replace(/\n/g,'<br>')+'</p>';
  }).join('');

  placeholders.forEach((tag, i)=>{
    const ph = new RegExp('@@TAG'+i+'@@','g');
    out = out.replace(ph, tag);
  });

  return out;
}

/* ===== Utilities ===== */
function el(tag, attrs={}, children=[]) {
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k === 'class') node.className = v;
    else if (k === 'html') node.innerHTML = v;
    else node.setAttribute(k, v);
  });
  [].concat(children).filter(Boolean).forEach(c => node.append(c));
  return node;
}
async function fetchJSON(url, options) {
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
function renderPlayer(embed){
  const wrap = document.getElementById('player');
  wrap.innerHTML = '';
  if (!embed || !embed.type) return;
  if (['youtube','vimeo','drive'].includes(embed.type)) {
    wrap.append(el('iframe', { src: embed.src, allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share', allowfullscreen:'' }));
  } else if (embed.type === 'video') {
    wrap.append(el('video', { src: embed.src, controls:'' }));
  } else {
    wrap.append(el('a', { href: embed.src, target:'_blank', rel:'noopener', class:'status' }, ['–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ']));
  }
}
function formatDT(v){
  try{ const d=new Date(v); return d.toLocaleString(undefined,{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return ''}
}

/* ===== State ===== */
let TOPICS = [];
let CURRENT = null;

/* ===== Build selector ===== */
function buildSelect(topics){
  const select = document.getElementById('topicSelect');
  select.innerHTML = '';
  topics.forEach(t=> select.append(el('option',{value:t.id},[t.title])));
  select.addEventListener('change', ()=> selectTopic(select.value));
}

/* ===== Comments ===== */
async function loadComments(topicId){
  const box = document.getElementById('comments');
  box.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  try{
    const data = await fetchJSON(`${API_BASE}?action=comments&topicId=${encodeURIComponent(topicId)}`);
    box.innerHTML = '';
    if (!data.comments || data.comments.length === 0){
      box.append(el('div', { class:'empty' }, ['–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!']));
      return;
    }
    data.comments.forEach(c=>{
      box.append(el('div', { class:'comment' }, [
        el('div', {}, [c.text]),
        el('small', {}, [`${c.name || '–°—Ç—É–¥–µ–Ω—Ç'} ¬∑ ${formatDT(c.ts)}`])
      ]));
    });
  }catch(err){
    box.innerHTML = '<div class="empty" style="color:#b91c1c">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</div>';
  }
}

/* ===== Likes (1 —Ä–∞–∑ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ) ===== */
function getDeviceToken(){
  let t = localStorage.getItem('kdb_device_token');
  if (!t) {
    t = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)) + String(Date.now());
    localStorage.setItem('kdb_device_token', t);
  }
  return t;
}
function updateLikeUiDisabled(disabled){
  const btn = document.getElementById('likeBtn');
  if (disabled) btn.classList.add('disabled'); else btn.classList.remove('disabled');
}
async function refreshLikes(topicId){
  try{
    const data = await fetchJSON(`${API_BASE}?action=reactions&topicId=${encodeURIComponent(topicId)}`);
    document.getElementById('likeCount').textContent = (data.reactions && data.reactions.likes) || 0;
  }catch{}
}
async function likeCurrent(){
  if (!CURRENT) return;
  if (localStorage.getItem('liked_'+CURRENT.id)) { updateLikeUiDisabled(true); return; }

  const fd = new FormData();
  fd.append('action','like');
  fd.append('topicId', CURRENT.id);
  fd.append('token', getDeviceToken());

  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok || json.already){
      document.getElementById('likeCount').textContent = (json.likes || 0);
      localStorage.setItem('liked_'+CURRENT.id, '1');
      updateLikeUiDisabled(true);
    }
  }catch{}
}

/* ===== Share ===== */
async function shareCurrent(){
  if (!CURRENT) return;
  const title = CURRENT.title;
  const url = location.href.split('#')[0] + '#topic=' + encodeURIComponent(CURRENT.id);
  const text = '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–µ–º—É: ' + title;
  if (navigator.share){ try{ await navigator.share({ title, text, url }); }catch{} }
  else {
    try{ await navigator.clipboard.writeText(url); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + url); }
    catch{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', url); }
  }
}

/* ===== Select topic ===== */
async function selectTopic(id){
  const t = TOPICS.find(x=>String(x.id)===String(id));
  if (!t) return;
  CURRENT = t;

  document.getElementById('topicTitle').textContent = t.title;
  renderPlayer(t.embed);

  const desc = document.getElementById('desc');
  // –ï—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –æ—Ç–¥–∞—ë—Ç –≥–æ—Ç–æ–≤—ã–π HTML (descriptionHtml) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ,
  // –∏–Ω–∞—á–µ Markdown + —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ inline-—Ç–µ–≥–∏:
  desc.innerHTML = t.descriptionHtml ? t.descriptionHtml : mdToHtml(t.description || '');

  document.getElementById('card').hidden = false;
  document.getElementById('pageStatus').textContent = '';

  await loadComments(id);
  await refreshLikes(id);
  updateLikeUiDisabled( !!localStorage.getItem('liked_'+id) );

  history.replaceState(null, '', '#topic=' + encodeURIComponent(id));
}

/* ===== Boot ===== */
async function boot(){
  const status = document.getElementById('pageStatus');
  try{
    const data = await fetchJSON(`${API_BASE}?action=topics`);
    TOPICS = data.topics || [];
    if (TOPICS.length === 0){
      status.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤. –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ª–∏—Å—Ç ¬´–ë–∞–∑–∞¬ª.';
      return;
    }
    buildSelect(TOPICS);
    const hash = new URL(location.href).hash;
    const m = hash.match(/topic=([^&]+)/);
    const initialId = m ? decodeURIComponent(m[1]) : TOPICS[0].id;
    document.getElementById('topicSelect').value = initialId;
    await selectTopic(initialId);
  }catch(err){
    const msg = (err && err.message) ? err.message : 'unknown';
    status.innerHTML = '<span style="color:#b91c1c">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ('+msg+'). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE –∏ –¥–æ—Å—Ç—É–ø –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</span>';
  }
}

/* Events */
document.getElementById('likeBtn').addEventListener('click', likeCurrent);
document.getElementById('shareBtn').addEventListener('click', shareCurrent);
document.getElementById('commentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!CURRENT) return;
  const msg = document.getElementById('commentMsg');
  msg.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

  const fd = new FormData();
  fd.append('action','addComment');
  fd.append('topicId', CURRENT.id);
  fd.append('name', e.target.name.value.trim());
  fd.append('text', e.target.text.value.trim());

  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok){
      msg.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω ‚úî';
      e.target.reset();
      await loadComments(CURRENT.id);
    } else {
      msg.textContent = '–û—à–∏–±–∫–∞: ' + (json.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
    }
  }catch{
    msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
  }
});

boot();
</script>
</body>
</html>
