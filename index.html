<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî –ö–î–ë ‚Ññ1</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --brand:#0A66C2;
    --bg:#F7FAFF;
    --panel:#ffffff;
    --text:#0F172A;
    --muted:#64748B;
    --line:#E6ECF5;
    --radius:16px;
    --shadow:0 10px 28px rgba(2,8,23,.06), 0 2px 10px rgba(2,8,23,.04);
  }

  /* –õ—ç–π–∞—É—Ç –¥–ª—è ¬´–ø—Ä–∏–∂–∞—Ç–æ–≥–æ¬ª —Ñ—É—Ç–µ—Ä–∞ */
  html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
  main.wrap { flex: 1; }

  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}
  body{padding-bottom:80px}

  /* Header */
  header{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.9));
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:960px;margin:0 auto;padding:12px 18px}
  .header-row{display:flex; gap:12px; align-items:center}
  .logo{ width:54px; height:72px; display:grid; place-items:center; flex:0 0 auto; padding:4px; border-radius:12px; background:linear-gradient(180deg,#fff,#f6f9ff); border:1px solid var(--line) }
  .logo img{ width:100%; height:100%; object-fit:contain }
  .header-title{margin:0; font-weight:900; font-size:18px; line-height:1.35; letter-spacing:.1px; color:#0B2E5E}
  .header-sub{margin:4px 0 0; color:#0B2E5E; font-size:13px; font-weight:700}

  /* Main grid */
  main.wrap{ display:grid; gap:22px; }

  /* –û–±—â–∏–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–µ–∫ */
  .block{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }

  /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–æ–≤ */
  .block h2{
    margin:0 0 8px;
    font-size:22px; font-weight:900; color:#0B2E5E;
  }

  /* –°–µ–ª–µ–∫—Ç–æ—Ä —Ç–µ–º—ã */
  .theme-select label{
    font-size:20px;
    font-weight:900;
    color:#0B2E5E;
    margin-bottom:8px;
    display:block;
  }
  select{
    width:100%; padding:12px 14px;
    border:1px solid var(--line); border-radius:12px;
    background:#fff; color:#0f172a; font:inherit; outline:none;
  }

  /* –ö–æ–Ω—Ç–µ–Ω—Ç */
  .topic-title{ font-size:26px; font-weight:900; margin:0 0 8px; line-height:1.2; letter-spacing:.2px; color:#0B2E5E }
  .player{ width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; border:1px solid #0b2e5e14; position:relative; }
  .player iframe, .player video{ width:100%; height:100%; display:block; border:0; }

  /* ===== –ö–ê–°–¢–û–ú–ù–´–ô –ú–ò–ù–ò-–ü–õ–ï–ï–† ===== */
  .vplayer{ position:relative; width:100%; height:100%; background:#000; }
  .vplayer video{ width:100%; height:100%; display:block; object-fit:cover; background:#000; }

  .vplayer .vp-hit{ position:absolute; inset:0; cursor:pointer; background:transparent; }
  .vp-center{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
  .vp-bigplay{
    width:66px; height:66px; border-radius:50%;
    background:rgba(255,255,255,.9); border:1px solid var(--line);
    display:grid; place-items:center; box-shadow:0 8px 24px rgba(2,8,23,.24);
    transform:scale(1); transition:transform .12s ease, opacity .12s ease;
  }
  .vplayer.paused .vp-bigplay{ transform:scale(1); opacity:1; }
  .vplayer.playing .vp-bigplay{ transform:scale(.9); opacity:0; }

  .vp-controls{
    position:absolute; left:0; right:0; bottom:0;
    display:flex; align-items:center; gap:10px;
    padding:8px 10px;
    background:linear-gradient(180deg, rgba(2,8,23,0) 0%, rgba(2,8,23,.55) 100%);
    transition:opacity .2s ease;
  }
  .vplayer.hide-ui .vp-controls{ opacity:0; pointer-events:none; }

  .vp-btn{
    width:36px; height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.12); display:grid; place-items:center; cursor:pointer;
    color:#fff;
  }
  .vp-btn:active{ transform:translateY(1px); }
  .vp-icon{ width:18px; height:18px; display:block; }

  .vp-time{ color:#fff; font-size:12px; min-width:84px; text-align:center; opacity:.9; }

  .vp-range{
    -webkit-appearance:none; appearance:none; height:4px; flex:1;
    background:rgba(255,255,255,.35); border-radius:999px; cursor:pointer;
  }
  .vp-range::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:14px; height:14px; border-radius:50%;
    background:#fff; border:1px solid rgba(2,8,23,.18);
    box-shadow:0 2px 8px rgba(2,8,23,.25);
    margin-top:-5px;
  }
  .vp-range::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:#fff; border:none; }

  .desc{display:grid; gap:10px}
  .desc p{margin:0}
  .desc h1,.desc h2,.desc h3{margin:4px 0 2px}
  .desc ul{margin:2px 0 0; padding-left:22px}
  .desc a{color:var(--brand); text-decoration:underline}

  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff;
    padding:11px 14px; border-radius:12px; font-weight:800; display:inline-flex; align-items:center; gap:8px;
    cursor:pointer; transition:transform .06s.ease, box-shadow .2s ease, opacity .2s ease;
    box-shadow:0 6px 16px rgba(10,102,194,.18);
  }
  .btn.secondary{background:#fff; color:var(--brand)}
  .btn:active{ transform:translateY(1px); }
  .btn.disabled{opacity:.6; background:#e5ecf6; border-color:#e5ecf6; color:#6b7280; pointer-events:none}
  .like-count{display:inline-block; min-width:28px; padding:2px 8px; background:#fff; color:#0B2E5E; border-radius:999px; border:1px solid #cfe0f3; font-weight:800}

  /* AI */
  .ai-note{font-size:13px; color:#334155; margin:6px 0 0}
  .ai-answer{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#F1F5FE; margin-top:16px; }
  .ai-answer .muted{color:#64748B; font-size:14px}

  .actions.vertical{ display:flex; flex-direction:column; align-items:stretch; }
  .actions.vertical .btn{ width:100%; display:flex; justify-content:center; }
  #aiStatus{ margin-top:6px; text-align:center; font-size:14px; color:#64748B; }

  form.comment-form{display:grid; gap:10px}
  input[type="text"], textarea{
    width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; color:#000; font:inherit
  }
  textarea{min-height:96px; resize:vertical}
  .status{margin-top:2px; font-size:14px; color:#64748B}
  .comments{ display:grid; gap:12px; }
  .comment-list{display:grid; gap:10px}
  .comment{ background:#F5F9FF; border:1px solid var(--line); border-radius:12px; padding:10px; }
  .comment small{color:#64748B; display:block; margin-top:6px}
  .empty{padding:10px;color:#64748B;font-size:14px}

  /* Footer */
  footer{ margin-top:auto; background:#ffffff; border-top:1px solid #E6ECF5; }
  .footer-bar{
    max-width:960px; margin:0 auto; padding:14px 18px;
    font-size:14px; font-weight:500; color:#0B2E5E;
    display:flex; align-items:center; justify-content:center; gap:6px;
  }
  .footer-bar a{ color:#0A66C2; text-decoration:none; font-weight:600; }
  .footer-bar a:hover{ text-decoration:underline; }

  /* ===== Fullscreen Splash / –ü—Ä–µ–ª–æ–∞–¥–µ—Ä ===== */
  #splash{
    position: fixed; inset: 0; z-index: 9999;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(10,102,194,.15), transparent 60%),
      linear-gradient(180deg, #f7faff, #eef5ff);
    display: grid; place-items: center;
    transition: opacity .4s ease, visibility .4s ease;
  }
  #splash.hide{ opacity:0; visibility:hidden; }
  .splash-inner{
    display:grid; gap:16px; justify-items:center; text-align:center;
    padding:24px 28px; border-radius:16px; background:#fff; border:1px solid var(--line);
    box-shadow:var(--shadow);
  }
  /* –ö–∞—Ä—Ç–∏–Ω–∫–∞ –±–µ–∑ —Ç–µ–Ω–µ–π */
  .splash-img{
    width:160px; height:auto; object-fit:contain; display:block;
    border:none; box-shadow:none; background:transparent;
  }
  .spinner{
    width:48px; height:48px; border-radius:50%;
    border:4px solid rgba(10,102,194,.15); border-top-color:var(--brand);
    animation: spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .splash-text{ font-size:16px; line-height:1.45; color:#0B2E5E; }
  .splash-text strong{ font-size:18px; }
</style>
</head>
<body>

<!-- ===== Splash / –ü—Ä–µ–ª–æ–∞–¥–µ—Ä ===== -->
<div id="splash" aria-live="polite">
  <div class="splash-inner">
    <img
      class="splash-img"
      src="https://s00.yaplakal.com/pics/pics_preview/2/8/8/20122882.jpg"
      alt="–ó–∞–≥—Ä—É–∑–∫–∞"
    >
    <div class="spinner" aria-hidden="true"></div>
    <div class="splash-text">
      <strong>–ì–æ—Ç–æ–≤–∏–º –ª—É—á—à–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –í–∞—Å</strong><br>
      –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥‚Ä¶
    </div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="logo">
        <img src="https://www.tajmedun.tj/bitrix/templates/tajmedun/images/logo_new2.png" alt="–õ–æ–≥–æ—Ç–∏–ø –¢–ì–ú–£">
      </div>
      <div>
        <h1 class="header-title">–ì–û–£ "–¢–ì–ú–£ –ò–ú–ï–ù–ò –ê–ë–£–ê–õ–ò –ò–ë–ù–ò –°–ò–ù–û"</h1>
        <p class="header-sub">–ö–∞—Ñ–µ–¥—Ä–∞ –¥–µ—Ç—Å–∫–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π ‚Ññ1 –∏–º–µ–Ω–∏ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ –ê–º–∏–Ω–æ–≤–∞ –•.–î–∂.</p>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- –ë–ª–æ–∫: –í—ã–±–æ—Ä —Ç–µ–º—ã -->
  <section class="block" id="block-select">
    <div class="theme-select">
      <label for="topicSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</label>
      <select id="topicSelect" aria-label="–í—ã–±–æ—Ä —Ç–µ–º—ã"></select>
    </div>
  </section>

  <!-- –ë–ª–æ–∫: –í–∏–¥–µ–æ -->
  <section class="block" id="block-video" hidden>
    <h2 class="topic-title" id="topicTitle">–¢–µ–º–∞</h2>
    <div id="player" class="player"></div>
  </section>

  <!-- –ë–ª–æ–∫: –û–ø–∏—Å–∞–Ω–∏–µ -->
  <section class="block" id="block-desc" hidden>
    <div id="desc" class="desc"></div>
  </section>

  <!-- –ë–ª–æ–∫: –ò–ò -->
  <section class="block" id="block-ai" hidden>
    <h2><strong>–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ò–ò –ø–æ —Ç–µ–º–µ</strong></h2>
    <p class="ai-note"></p>
    <form id="aiForm" class="comment-form">
      <textarea id="aiQuestion" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò –º–≥–Ω–æ–≤–µ–Ω–Ω–æ" required></textarea>
      <div class="actions vertical">
        <button id="askBtn" class="btn" type="submit">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      </div>
      <span id="aiStatus" class="status"></span>
    </form>
    <div id="aiAnswer" class="ai-answer" hidden>
      <div class="muted">–û—Ç–≤–µ—Ç:</div>
      <div id="aiAnswerBody"></div>
    </div>
  </section>

  <!-- –ë–ª–æ–∫: –ù—Ä–∞–≤–∏—Ç—Å—è / –ü–æ–¥–µ–ª–∏—Ç—å—Å—è / –í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
  <section class="block" id="block-social" hidden>
    <div class="actions" style="margin-bottom:8px">
      <button id="likeBtn" class="btn" type="button">üëç –ù—Ä–∞–≤–∏—Ç—Å—è <span class="like-count" id="likeCount">0</span></button>
      <button id="shareBtn" class="btn secondary" type="button">‚Üó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <form id="commentForm" class="comment-form" aria-label="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
      <input name="name" type="text" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      <textarea name="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" required></textarea>
      <button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <div id="commentMsg" class="status"></div>

    <section class="comments" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" style="margin-top:10px">
      <div id="comments" class="comment-list">
        <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>

    <p id="pageStatus" class="status" style="margin:2px 2px 0;"></p>
  </section>
</main>

<footer>
  <div class="footer-bar">
    <span>–ë–∞–∫–æ–µ–≤ –§–∞—Ä—Ä—É—Ö</span> |
    <a href="https://www.instagram.com/doc.farrukh" target="_blank" rel="noopener">doc.farrukh</a>
  </div>
</footer>

<script>
/* –æ—Ç–º–µ—Ç–∏–º —Å—Ç–∞—Ä—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–ø–ª—ç—à–∞ */
window.__splashStart = performance.now();

/* ===== URL –≤–∞—à–µ–≥–æ Apps Script (‚Ä¶/exec) ===== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbzOHsdsOVo-f7fPS0O4ln1WuBqne-iijScqJ4vwVgc_WunSMJ6uiYS-2frNNzzMn7HyxQ/exec'.trim();

/* ===== Markdown ‚Üí HTML ===== */
function mdToHtml(md){
  if(!md) return '';
  let out = md
    .replace(/^###\s+(.*)$/gm,'<h3>$1</h3>')
    .replace(/^##\s+(.*)$/gm,'<h2>$1</h2>')
    .replace(/^#\s+(.*)$/gm,'<h1>$1</h1>')
    .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>')
    .replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g,'<em>$1</em>');
  out = out.split(/\n{2,}/).map(p=>{
    if(/^<h\d/.test(p.trim())) return p;
    return '<p>'+p.trim().replace(/\n/g,'<br>')+'</p>';
  }).join('');
  return out;
}

/* ===== Helpers ===== */
function el(tag, attrs={}, children=[]){
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==='class') node.className=v;
    else if (k==='html') node.innerHTML=v;
    else if (v!==undefined && v!==null) node.setAttribute(k,v);
  });
  [].concat(children).filter(Boolean).forEach(c=>node.append(c));
  return node;
}
async function fetchJSON(url, options){
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}

/* ====== –†–µ–Ω–¥–µ—Ä –≤–∏–¥–µ–æ / –ø–ª–µ–µ—Ä–∞ ====== */
function renderPlayer(embed){
  const wrap = document.getElementById('player');
  wrap.innerHTML = '';
  if (!embed || !embed.type) return;

  if (['youtube','vimeo','drive'].includes(embed.type)) {
    wrap.append(el('iframe', {
      src: embed.src,
      allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',
      allowfullscreen:''
    }));
  } else if (embed.type === 'video') {
    createCustomPlayer(wrap, embed.src, embed.poster);
  } else {
    wrap.append(el('a', { href: embed.src, target:'_blank', rel:'noopener', class:'status' }, ['–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ']));
  }
}

/* ====== –ö–ê–°–¢–û–ú–ù–´–ô –ü–õ–ï–ï–† ====== */
function createIcon(pathD){
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('viewBox','0 0 24 24'); svg.classList.add('vp-icon');
  const p = document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d', pathD); p.setAttribute('fill','currentColor');
  svg.appendChild(p); return svg;
}
function formatTime(s){
  s = Math.max(0, Math.floor(s||0));
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  if (h>0) return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  return `${m}:${String(sec).padStart(2,'0')}`;
}
function createCustomPlayer(container, src, poster){
  const root = el('div', { class:'vplayer paused' });
  const video = document.createElement('video');
  video.src = src;
  if (poster) video.poster = poster;
  video.playsInline = true;

  const hit = el('div', { class:'vp-hit' });

  const center = el('div', { class:'vp-center' });
  const bigPlay = el('div', { class:'vp-bigplay' });
  bigPlay.append(createIcon("M8 5v14l11-7z"));
  center.append(bigPlay);

  const bar = el('div', { class:'vp-controls' });

  const btnPlay = el('button', { class:'vp-btn', type:'button', 'aria-label':'–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–ü–∞—É–∑–∞' });
  const icoPlay = createIcon("M8 5v14l11-7z");
  const icoPause = createIcon("M6 5h4v14H6zM14 5h4v14h-4z");
  btnPlay.append(icoPlay);

  const time = el('div', { class:'vp-time' }, ['0:00 / 0:00']);

  const range = document.createElement('input');
  range.type = 'range'; range.min = 0; range.max = 1000; range.value = 0; range.className = 'vp-range';
  range.setAttribute('aria-label','–ü–æ–∑–∏—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');

  const btnMute = el('button', { class:'vp-btn', type:'button', 'aria-label':'–ó–≤—É–∫ –≤–∫–ª/–≤—ã–∫–ª' });
  const icoVol = createIcon("M5 9v6h4l5 4V5l-5 4H5z");
  const icoMute = createIcon("M16.5 12l3.5 3.5-1.5 1.5L15 13.5 11.5 17l-1.5-1.5L13.5 12 10 8.5 11.5 7l3.5 3.5 3.5-3.5L20.5 8.5 17 12z");
  btnMute.append(icoVol);

  const btnFs = el('button', { class:'vp-btn', type:'button', 'aria-label':'–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º' });
  const icoFs = createIcon("M7 14H5v5h5v-2H7v-3zm0-4h3V7h2v5H7V10zm7 9h5v-5h-2v3h-3v2zm3-13V3h-5v2h3v3h2z");
  btnFs.append(icoFs);

  bar.append(btnPlay, time, range, btnMute, btnFs);
  root.append(video, hit, center, bar);
  container.append(root);

  let hideTimer = null;
  const showUI = ()=>{
    root.classList.remove('hide-ui');
    clearTimeout(hideTimer);
    hideTimer = setTimeout(()=>root.classList.add('hide-ui'), 2000);
  };
  const togglePlay = ()=>{
    if (video.paused) video.play(); else video.pause();
  };
  const updatePlayState = ()=>{
    if (video.paused) {
      root.classList.add('paused'); root.classList.remove('playing');
      btnPlay.replaceChildren(icoPlay.cloneNode(true));
    } else {
      root.classList.add('playing'); root.classList.remove('paused');
      btnPlay.replaceChildren(icoPause.cloneNode(true));
      showUI();
    }
  };
  const updateTime = ()=>{
    const cur = video.currentTime || 0;
    const dur = video.duration || 0;
    time.textContent = `${formatTime(cur)} / ${dur?formatTime(dur):'0:00'}`;
    if (dur>0 && !rangeDragging) {
      range.value = Math.round(cur/dur*1000);
    }
  };

  btnPlay.addEventListener('click', togglePlay);
  bigPlay.addEventListener('click', (e)=>{ e.stopPropagation(); togglePlay(); });
  hit.addEventListener('click', togglePlay);
  [root, bar].forEach(elm=>{
    elm.addEventListener('mousemove', showUI, {passive:true});
    elm.addEventListener('touchstart', showUI, {passive:true});
  });

  video.addEventListener('play', updatePlayState);
  video.addEventListener('pause', updatePlayState);
  video.addEventListener('timeupdate', updateTime);
  video.addEventListener('loadedmetadata', updateTime);
  video.addEventListener('ended', ()=>{ root.classList.remove('hide-ui'); });

  let rangeDragging = false;
  range.addEventListener('input', ()=>{
    const dur = video.duration||0;
    if (dur>0){
      const to = (range.value/1000)*dur;
      video.currentTime = to;
      updateTime();
    }
  });
  range.addEventListener('mousedown', ()=>rangeDragging=true);
  range.addEventListener('mouseup', ()=>{ rangeDragging=false; });

  btnMute.addEventListener('click', ()=>{
    video.muted = !video.muted;
    btnMute.replaceChildren( (video.muted ? icoMute : icoVol).cloneNode(true) );
  });

  btnFs.addEventListener('click', async ()=>{
    try{
      if (!document.fullscreenElement) await root.requestFullscreen();
      else await document.exitFullscreen();
    }catch{}
  });

  showUI();
}

/* ===== Splash: —Å–∫—Ä—ã—Ç–∏–µ ===== */
function hideSplash(minDelayMs = 800){
  const el = document.getElementById('splash');
  if(!el) return;
  const start = window.__splashStart || performance.now();
  const wait = Math.max(0, minDelayMs - (performance.now() - start));
  setTimeout(()=>{
    el.classList.add('hide');
    setTimeout(()=>{ el.style.display = 'none'; }, 450);
  }, wait);
}
setTimeout(()=>hideSplash(0), 6000);

/* ===== State ===== */
let TOPICS = [];
let CURRENT = null;

/* ===== Build selector ===== */
function buildSelect(topics){
  const select = document.getElementById('topicSelect');
  select.innerHTML = '';
  topics.forEach(t=> select.append(el('option',{value:t.id},[t.title])));
  select.addEventListener('change', ()=> selectTopic(select.value));
}

/* ===== Comments ===== */
async function loadComments(topicId){
  const box = document.getElementById('comments');
  box.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  try{
    const data = await fetchJSON(`${API_BASE}?action=comments&topicId=${encodeURIComponent(topicId)}`);
    box.innerHTML = '';
    if (!data.comments || data.comments.length === 0){
      box.append(el('div', { class:'empty' }, ['–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!']));
      return;
    }
    data.comments.forEach(c=>{
      box.append(el('div', { class:'comment' }, [
        el('div', {}, [c.text]),
        el('small', {}, [`${c.name || '–°—Ç—É–¥–µ–Ω—Ç'} ¬∑ ${formatDT(c.ts)}`])
      ]));
    });
  }catch(err){
    box.innerHTML = '<div class="empty" style="color:#b91c1c">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</div>';
  }
}
function formatDT(v){
  try{ const d=new Date(v); return d.toLocaleString(undefined,{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return ''}
}

/* ===== Likes ===== */
function updateLikeUiDisabled(disabled){
  const btn = document.getElementById('likeBtn');
  btn.classList.toggle('disabled', !!disabled);
  btn.disabled = !!disabled;
}
async function refreshLikes(topicId){
  try{
    const data = await fetchJSON(`${API_BASE}?action=reactions&topicId=${encodeURIComponent(topicId)}`);
    document.getElementById('likeCount').textContent = (data.reactions && data.reactions.likes) || 0;
  }catch{}
}
async function likeCurrent(){
  if (!CURRENT) return;
  if (localStorage.getItem('liked_'+CURRENT.id)) { updateLikeUiDisabled(true); return; }
  const fd = new FormData();
  fd.append('action','like');
  fd.append('topicId', CURRENT.id);
  fd.append('token', (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2))+Date.now());
  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok || json.already){
      document.getElementById('likeCount').textContent = (json.likes || 0);
      localStorage.setItem('liked_'+CURRENT.id, '1');
      updateLikeUiDisabled(true);
    }
  }catch{}
}

/* ===== Share ===== */
async function shareCurrent(){
  if (!CURRENT) return;
  const title = CURRENT.title;
  const url = location.href.split('#')[0] + '#topic=' + encodeURIComponent(CURRENT.id);
  const text = '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–µ–º—É: ' + title;
  if (navigator.share){ try{ await navigator.share({ title, text, url }); }catch{} }
  else {
    try{ await navigator.clipboard.writeText(url); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + url); }
    catch{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', url); }
  }
}

/* ===== AI ===== */
function setAiBusy(busy, msg){
  const btn = document.getElementById('askBtn');
  const st  = document.getElementById('aiStatus');
  btn.classList.toggle('disabled', !!busy);
  btn.disabled = !!busy;
  st.textContent = msg || (busy ? '–ì–æ—Ç–æ–≤–∏–º –æ—Ç–≤–µ—Ç‚Ä¶' : '');
}
function showAiAnswer(html){
  const box = document.getElementById('aiAnswer');
  const body = document.getElementById('aiAnswerBody');
  body.innerHTML = html;
  box.hidden = false;
}
async function askAI(){
  if (!CURRENT) return;
  const qEl = document.getElementById('aiQuestion');
  const q = qEl.value.trim();
  if (!q) return;
  setAiBusy(true, '–§–æ—Ä–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç‚Ä¶');

  const fd = new FormData();
  fd.append('action','ask');
  fd.append('topicId', CURRENT.id);
  fd.append('question', q);

  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok){
      const html = mdToHtml((json.answer || '').trim());
      showAiAnswer(html || '<p><em>–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç</em></p>');
      setAiBusy(false, '–ì–æ—Ç–æ–≤–æ');
      qEl.value = '';
    } else {
      setAiBusy(false, '–û—à–∏–±–∫–∞: ' + (json.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
    }
  }catch(e){
    setAiBusy(false, '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

/* ===== Select topic ===== */
async function selectTopic(id){
  const t = TOPICS.find(x=>String(x.id)===String(id));
  if (!t) return;
  CURRENT = t;

  document.getElementById('topicTitle').textContent = t.title;
  renderPlayer(t.embed);
  document.getElementById('block-video').hidden = false;

  const desc = document.getElementById('desc');
  desc.innerHTML = t.descriptionHtml ? t.descriptionHtml : mdToHtml(t.description || '');
  document.getElementById('block-desc').hidden = false;

  document.getElementById('aiAnswer').hidden = true;
  document.getElementById('aiStatus').textContent = '';
  document.getElementById('block-ai').hidden = false;

  document.getElementById('block-social').hidden = false;

  await loadComments(id);
  await refreshLikes(id);
  updateLikeUiDisabled( !!localStorage.getItem('liked_'+id) );

  history.replaceState(null, '', '#topic=' + encodeURIComponent(id));
}

/* ===== Boot ===== */
async function boot(){
  try{
    const data = await fetchJSON(`${API_BASE}?action=topics`);
    TOPICS = data.topics || [];
    if (TOPICS.length === 0){
      hideSplash();
      return;
    }
    buildSelect(TOPICS);
    const hash = new URL(location.href).hash;
    const m = hash.match(/topic=([^&]+)/);
    const initialId = m ? decodeURIComponent(m[1]) : TOPICS[0].id;
    document.getElementById('topicSelect').value = initialId;
    await selectTopic(initialId);

    hideSplash();
  }catch(err){
    console.error(err);
    hideSplash();
  }
}

/* Events */
document.getElementById('likeBtn').addEventListener('click', likeCurrent);
document.getElementById('shareBtn').addEventListener('click', shareCurrent);
document.getElementById('commentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!CURRENT) return;
  const msg = document.getElementById('commentMsg');
  msg.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

  const fd = new FormData();
  fd.append('action','addComment');
  fd.append('topicId', CURRENT.id);
  fd.append('name', e.target.name.value.trim());
  fd.append('text', e.target.text.value.trim());

  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok){
      msg.textContent = '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω ‚úî';
      e.target.reset();
      await loadComments(CURRENT.id);
    } else {
      msg.textContent = '–û—à–∏–±–∫–∞: ' + (json.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
    }
  }catch{
    msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
  }
});

document.getElementById('aiForm').addEventListener('submit', (e)=>{ e.preventDefault(); askAI(); });

boot();
</script>
</body>
</html>
