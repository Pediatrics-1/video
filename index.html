<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ ‚Äî –ö–î–ë ‚Ññ1</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --brand:#0A66C2;
    --bg:#F7FAFF;
    --panel:#ffffff;
    --text:#0F172A;
    --muted:#64748B;
    --line:#E6ECF5;
    --radius:16px;
    --shadow:0 10px 28px rgba(2,8,23,.06), 0 2px 10px rgba(2,8,23,.04);

    --q-bg:#EFF6FF;
    --a-bg:#ECFDF5;
    --a-border:#BAE6D3;
    --q-border:#C7DAF5;
    --ok:#16A34A;
  }

  html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
  main.wrap { flex: 1; }
  *{box-sizing:border-box}
  html,body{background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}
  body{padding-bottom:80px}

  header{
    position:sticky; top:0; z-index:30;
    background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.9));
    backdrop-filter:saturate(160%) blur(10px);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:960px;margin:0 auto;padding:12px 18px}
  .header-row{display:flex; gap:12px; align-items:center}
  .logo{ width:54px; height:72px; display:grid; place-items:center; flex:0 0 auto; padding:4px; border-radius:12px; background:linear-gradient(180deg,#fff,#f6f9ff); border:1px solid var(--line) }
  .logo img{ width:100%; height:100%; object-fit:contain }
  .header-title{margin:0; font-weight:900; font-size:18px; line-height:1.35; letter-spacing:.1px; color:#0B2E5E}
  .header-sub{margin:4px 0 0; color:#0B2E5E; font-size:13px; font-weight:700}

  main.wrap{ display:grid; gap:22px; }
  .block{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  .block h2{ margin:0 0 8px; font-size:22px; font-weight:900; color:#0B2E5E; }

  .theme-select label{
    font-size:20px; font-weight:900; color:#0B2E5E; margin-bottom:8px; display:block;
  }
  select{
    width:100%; padding:12px 14px;
    border:1px solid var(--line); border-radius:12px;
    background:#fff; color:#0f172a; font:inherit; outline:none;
  }

  .topic-title{ font-size:26px; font-weight:900; margin:0 0 8px; line-height:1.2; letter-spacing:.2px; color:#0B2E5E }
  .player{ width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; border:1px solid #0b2e5e14; }
  .player iframe, .player video{ width:100%; height:100%; display:block; border:0; }

  .desc{display:grid; gap:10px}
  .desc p{margin:0}
  .desc h1,.desc h2,.desc h3{margin:4px 0 2px}
  .desc ul{margin:2px 0 0; padding-left:22px}
  .desc a{color:var(--brand); text-decoration:underline}

  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid var(--brand); background:var(--brand); color:#fff;
    padding:11px 14px; border-radius:12px; font-weight:800; display:inline-flex; align-items:center; gap:8px;
    cursor:pointer; transition:transform .06s ease, box-shadow .2s ease, opacity .2s ease;
    box-shadow:0 6px 16px rgba(10,102,194,.18);
  }
  .btn.secondary{background:#fff; color:var(--brand)}
  .btn:active{ transform:translateY(1px); }
  .btn.disabled{opacity:.6; background:#e5ecf6; border-color:#e5ecf6; color:#6b7280; pointer-events:none}
  .btn.wide{ width:100%; justify-content:center; }
  .like-count{display:inline-block; min-width:28px; padding:2px 8px; background:#fff; color:#0B2E5E; border-radius:999px; border:1px solid #cfe0f3; font-weight:800}

  .ai-answer{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#F1F5FE; margin-top:16px; }
  .actions.vertical{ display:flex; flex-direction:column; align-items:stretch; }
  #aiStatus{ margin-top:6px; text-align:center; font-size:14px; color:#64748B; }

  .qa-wrap{ margin-top:12px; }
  .qa-title{ font-size:18px; font-weight:900; color:#0B2E5E; margin-bottom:16px; }
  .qa-list{ display:grid; gap:10px; }
  .qa-item{ background:#F5F9FF; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .qa-q{ font-weight:800; color:#0B2E5E; margin:0 0 6px; }
  .qa-a{ margin:0; color:#0F172A; }

  form.comment-form{display:grid; gap:10px}
  input[type="text"], textarea{
    width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; color:#000; font:inherit
  }
  textarea{min-height:120px; resize:vertical}
  .comment-form .btn{ width:100%; justify-content:center; }
  .status{margin-top:2px; font-size:14px; color:#64748B}
  .comments{ display:grid; gap:12px; }
  .comment-list{display:grid; gap:10px}
  .comment{ background:#F5F9FF; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .comment small{color:#64748B; display:block; margin-top:6px}
  .empty{padding:10px;color:#64748B;font-size:14px}

  footer{ margin-top:auto; background:#ffffff; border-top:1px solid #E6ECF5; }
  .footer-bar{
    max-width:960px; margin:0 auto; padding:14px 18px;
    font-size:14px; font-weight:500; color:#0B2E5E;
    display:flex; align-items:center; justify-content:center; gap:6px;
  }
  .footer-bar a{ color:#0A66C2; text-decoration:none; font-weight:600; }
  .footer-bar a:hover{ text-decoration:underline; }

  #splash{
    position: fixed; inset: 0; z-index: 9999;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(10,102,194,.15), transparent 60%),
      linear-gradient(180deg, #f7faff, #eef5ff);
    display: grid; place-items: center;
    transition: opacity .4s ease, visibility .4s ease;
  }
  #splash.hide{ opacity:0; visibility:hidden; }
  .splash-inner{
    display:grid; gap:16px; justify-items:center; text-align:center;
    padding:24px 28px; border-radius:16px; background:#fff; border:1px solid var(--line);
    box-shadow:var(--shadow);
  }
  .splash-img{ width:160px; height:auto; object-fit:contain; display:block; border:none; box-shadow:none; background:transparent; }
  .spinner{
    width:48px; height:48px; border-radius:50%;
    border:4px solid rgba(10,102,194,.15); border-top-color:var(--brand);
    animation: spin 1s linear infinite;
  }
  .spinner--sm{ width:24px; height:24px; border-width:3px; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  .splash-text{ font-size:16px; line-height:1.45; color:#0B2E5E; }
  .splash-text strong{ font-size:18px; }

  /* Tabs */
  .tabs{ display:flex; gap:12px; }
  .tab{
    appearance:none; border:1px solid var(--line); background:#fff; color:#0B2E5E;
    padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:900; letter-spacing:.2px;
    flex:1 1 0; text-align:center;
  }
  .tab.active{ background:var(--brand); color:#fff; border-color:transparent; box-shadow:0 6px 16px rgba(10,102,194,.18)}

  /* Cards */
  .stage{display:grid; place-items:center}
  .card{ width:min(720px,100%); height:420px; position:relative; perspective:1200px; }
  .card-inner{position:absolute; inset:0; transform-style:preserve-3d; transition:transform .45s cubic-bezier(.2,.7,.2,1)}
  .card.is-flipped .card-inner{ transform:rotateY(180deg) }
  .face{
    position:absolute; inset:0; backface-visibility:hidden; -webkit-backface-visibility:hidden;
    border:1px solid var(--line); border-radius:var(--radius);
    box-shadow:var(--shadow); display:flex; flex-direction:column; justify-content:center; align-items:center;
    text-align:center; padding:28px;
  }
  .front{ background:var(--q-bg); border-color:var(--q-border); }
  .back{ transform:rotateY(180deg); background:var(--a-bg); border-color:var(--a-border); }
  .face h2{ margin:0 0 10px; font-size:clamp(18px,2.2vw,24px) }
  .face p{ margin:0; font-size:clamp(16px,2vw,20px) }
  .hint{margin-top:14px; color:#475569; font-size:14px}
  .toolbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px}
  .toolbar .btn{ font-weight:800 }
  .progress{width:100%; height:8px; background:#EEF2FF; border-radius:999px; overflow:hidden; border:1px solid var(--line); margin-top:10px}
  .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--brand),#22C55E); transition:width .3s }
  .congrats{
    display:none; margin-top:12px; padding:12px 14px; border-radius:12px; border:1px solid #CDEFCF;
    background:#F0FFF4; color:#065F46; font-weight:700;
  }
  .congrats.show{ display:block; }
  @media (max-width:640px){ .card{height:380px} }

  /* Overlay –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */
  .gen-overlay{
    position:fixed; inset:0; z-index:60;
    background:linear-gradient(180deg,rgba(255,255,255,.86),rgba(255,255,255,.92));
    backdrop-filter: blur(6px) saturate(120%);
    display:none; place-items:center;
  }
  .gen-overlay.show{ display:grid; animation: fadeIn .2s ease; }
  @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
  .gen-box{
    background:#fff; border:1px solid var(--line); border-radius:16px; padding:18px 20px; box-shadow:var(--shadow);
    display:grid; gap:10px; justify-items:center; text-align:center; max-width:520px;
  }
  .gen-txt{ color:#0B2E5E; font-weight:800 }
  .dots:after{
    content:""; display:inline-block; width:1.2em; text-align:left; animation: ellipsis 1.2s steps(4,end) infinite;
  }
  @keyframes ellipsis{ 0%{content:""} 25%{content:"."} 50%{content:".."} 75%{content:"..."} 100%{content:""} }
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" aria-live="polite">
  <div class="splash-inner">
    <img class="splash-img" src="https://s00.yaplakal.com/pics/pics_preview/2/8/8/20122882.jpg" alt="–ó–∞–≥—Ä—É–∑–∫–∞">
    <div class="spinner" aria-hidden="true"></div>
    <div class="splash-text">
      <strong>–ì–æ—Ç–æ–≤–∏–º –ª—É—á—à–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –í–∞—Å</strong><br>–ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥‚Ä¶
    </div>
  </div>
</div>

<!-- Overlay –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ -->
<div id="genOverlay" class="gen-overlay" aria-live="polite">
  <div class="gen-box">
    <div class="spinner" aria-hidden="true"></div>
    <div class="gen-txt">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è<span class="dots"></span></div>
    <div style="font-size:14px; color:#64748B">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥</div>
  </div>
</div>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="logo">
        <img src="https://www.tajmedun.tj/bitrix/templates/tajmedun/images/logo_new2.png" alt="–õ–æ–≥–æ—Ç–∏–ø –¢–ì–ú–£">
      </div>
      <div>
        <h1 class="header-title">–ì–û–£ "–¢–ì–ú–£ –ò–ú–ï–ù–ò –ê–ë–£–ê–õ–ò –ò–ë–ù–ò –°–ò–ù–û"</h1>
        <p class="header-sub">–ö–∞—Ñ–µ–¥—Ä–∞ –¥–µ—Ç—Å–∫–∏—Ö –±–æ–ª–µ–∑–Ω–µ–π ‚Ññ1 –∏–º–µ–Ω–∏ –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä–∞ –ê–º–∏–Ω–æ–≤–∞ –•.–î–∂.</p>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- –í—ã–±–æ—Ä —Ç–µ–º—ã -->
  <section class="block" id="block-select">
    <div class="theme-select">
      <label for="topicSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</label>
      <select id="topicSelect" aria-label="–í—ã–±–æ—Ä —Ç–µ–º—ã"></select>
    </div>
  </section>

  <!-- –í–∫–ª–∞–¥–∫–∏ -->
  <section class="block" id="block-tabs">
    <div class="tabs">
      <button class="tab active" id="tab-material">–ú–∞—Ç–µ—Ä–∏–∞–ª</button>
      <button class="tab" id="tab-cards">–ö–∞—Ä—Ç–æ—á–∫–∏ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏</button>
    </div>
  </section>

  <!-- –í–∏–¥–µ–æ -->
  <section class="block" id="block-video" hidden>
    <h2 class="topic-title" id="topicTitle">–¢–µ–º–∞</h2>
    <div id="player" class="player"></div>
  </section>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
  <section class="block" id="block-desc" hidden>
    <div id="desc" class="desc"></div>
  </section>

  <!-- –ò–ò —á–∞—Ç –ø–æ —Ç–µ–º–µ -->
  <section class="block" id="block-ai" hidden>
    <h2><strong>–ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ò–ò –ø–æ —Ç–µ–º–µ</strong></h2>
    <form id="aiForm" class="comment-form">
      <textarea id="aiQuestion" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò –º–≥–Ω–æ–≤–µ–Ω–Ω–æ" required></textarea>
      <div class="actions vertical">
        <button id="askBtn" class="btn" type="submit">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      </div>
      <span id="aiStatus" class="status"></span>
    </form>
    <div id="aiAnswer" class="ai-answer" hidden>
      <div class="muted">–û—Ç–≤–µ—Ç:</div>
      <div id="aiAnswerBody"></div>
    </div>

    <hr style="margin:24px 0; border:none; border-top:1px solid var(--line)">
    <div class="qa-wrap">
      <div class="qa-title">–í–æ–ø—Ä–æ—Å—ã –ò–ò</div>
      <div id="qaBox" class="qa-list">
        <div class="empty">
          <div class="spinner spinner--sm" aria-hidden="true"></div>
          –ò—â–µ–º –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ò–ò‚Ä¶
        </div>
      </div>
    </div>
  </section>

  <!-- –ö–ê–†–¢–û–ß–ö–ò -->
  <section class="block" id="block-cards" hidden>
  <h2 class="topic-title">–ü—Ä–æ–≤–µ—Ä—å —Å–µ–±—è</h2>

  <div id="cardsStatus" class="status" style="margin-bottom:10px"></div>

  <!-- –ö–ù–û–ü–ö–ê –ì–ï–ù–ï–†–ê–¶–ò–ò ‚Äî —Ç–µ–ø–µ—Ä—å –°–í–ï–†–•–£ -->
  <div class="actions vertical" style="margin:10px 0 14px">
    <button class="btn wide" id="genCards">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>

  <div class="stage" style="margin-top:10px">
    <div class="card" id="cardBox" tabindex="0" aria-live="polite">
      <div class="card-inner">
        <section class="face front">
          <h2 id="qTitle">–í–æ–ø—Ä–æ—Å</h2>
          <p id="qText">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–æ–ø—Ä–æ—Å—ã‚Ä¶</p>
          <div class="hint"></div>
        </section>
        <section class="face back">
          <h2>–û—Ç–≤–µ—Ç</h2>
          <p id="aText">‚Äî</p>
          <div class="hint"></div>
        </section>
      </div>
    </div>
  </div>

  <div class="progress"><div class="bar" id="cardsBar"></div></div>
  <div id="cardsCongrats" class="congrats">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —ç—Ç–æ–π —Ç–µ–º—ã. –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!</div>
  <div class="status" style="margin-top:8px"></div>

  <!-- –°–¢–†–ï–õ–ö–ò ‚Äî —Ç–µ–ø–µ—Ä—å –°–ù–ò–ó–£ -->
  <div class="toolbar" style="margin-top:12px">
    <button class="btn secondary" id="prevCard">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
    <span class="status"><strong id="cardsCounter">0/0</strong></span>
    <button class="btn" id="nextCard">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å ‚Üí</button>
  </div>
</section>


  <!-- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ -->
  <section class="block" id="block-social" hidden>
    <div class="actions" style="margin-bottom:8px">
      <button id="likeBtn" class="btn" type="button">üëç –ù—Ä–∞–≤–∏—Ç—Å—è <span class="like-count" id="likeCount">0</span></button>
      <button id="shareBtn" class="btn secondary" type="button">‚Üó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <form id="commentForm" class="comment-form" aria-label="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
      <input name="name" type="text" placeholder="–í–∞—à–µ –∏–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      <textarea name="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶" required></textarea>
      <button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
    <div id="commentMsg" class="status"></div>

    <section class="comments" aria-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" style="margin-top:10px">
      <div id="comments" class="comment-list">
        <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </section>

    <p id="pageStatus" class="status" style="margin:2px 2px 0;"></p>
  </section>
</main>

<footer>
  <div class="footer-bar">
    <span>–ë–∞–∫–æ–µ–≤ –§–∞—Ä—Ä—É—Ö</span> |
    <a href="https://www.instagram.com/doc.farrukh" target="_blank" rel="noopener">doc.farrukh</a>
  </div>
</footer>

<script>
window.__splashStart = performance.now();
const API_BASE = 'https://script.google.com/macros/s/AKfycbyLSpy8hu9E1YzYCrB4uHC36X_svs3Rf3wnCWOHMpA1dcFtkGmpyBGUS0cqmBG3RkNELg/exec'.trim();

/* ============ UTIL ============ */
function mdToHtml(md){
  if(!md) return '';
  md = String(md).replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
  md = md
    .replace(/^###\s+(.*)$/gm,'<h3>$1</h3>')
    .replace(/^##\s+(.*)$/gm,'<h2>$1</h2>')
    .replace(/^#\s+(.*)$/gm,'<h1>$1</h1>');
  md = md.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
  md = md.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>');
  const out = md.split(/\n{2,}/).map(p=>/^<h\d/i.test(p.trim())?p:'<p>'+p.trim().replace(/\n/g,'<br>')+'</p>').join('');
  return out;
}
function el(tag, attrs={}, children=[]){
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==='class') node.className=v;
    else if (k==='html') node.innerHTML=v;
    else if (v!==undefined && v!==null) node.setAttribute(k,v);
  });
  [].concat(children).filter(Boolean).forEach(c=>node.append(c));
  return node;
}
async function fetchJSON(url, options){
  const res = await fetch(url, options);
  if (!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
function hideSplash(minDelayMs = 800){
  const elx = document.getElementById('splash'); if(!elx) return;
  const start = window.__splashStart || performance.now();
  const wait = Math.max(0, minDelayMs - (performance.now() - start));
  setTimeout(()=>{ elx.classList.add('hide'); setTimeout(()=>{ elx.style.display='none'; }, 450); }, wait);
}
setTimeout(()=>hideSplash(0), 6000);

/* ============ State ============ */
let TOPICS = [];
let CURRENT = null;

function buildSelect(topics){
  const select = document.getElementById('topicSelect');
  select.innerHTML = '';
  topics.forEach(t=> select.append(el('option',{value:t.id},[t.title])));
  select.addEventListener('change', ()=> selectTopic(select.value));
}

/* ============ Player ============ */
function renderPlayer(embed){
  const wrap = document.getElementById('player');
  wrap.innerHTML = '';
  if (!embed || !embed.type) return;
  if (['youtube','vimeo','drive'].includes(embed.type)) {
    wrap.append(el('iframe', {
      src: embed.src,
      allow: 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',
      allowfullscreen:''
    }));
  } else if (embed.type === 'video') {
    const v = document.createElement('video'); v.src = embed.src; v.controls = true; v.playsInline = true; wrap.append(v);
  } else {
    wrap.append(el('a', { href: embed.src, target:'_blank', rel:'noopener', class:'status' }, ['–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ']));
  }
}

/* ============ QA ============ */
let qaLoadedFor = null;
async function loadQA(topicId){
  const box = document.getElementById('qaBox');
  box.innerHTML = '<div class="empty"><div class="spinner spinner--sm" aria-hidden="true"></div>–ò—â–µ–º –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ò–ò‚Ä¶</div>';
  try{
    const data = await fetchJSON(`${API_BASE}?action=qa&topicId=${encodeURIComponent(topicId)}`);
    const items = (data && data.qa) || [];
    box.innerHTML = items.length ? '' : '<div class="empty">–ü–æ–∫–∞ —á—Ç–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç ‚Äî –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–µ—Ä–≤—ã–º!</div>';
    items.forEach(row=>{
      const q = String(row.q||'').trim();
      const a = mdToHtml(String(row.a||'').trim());
      box.append(el('div',{class:'qa-item'},[ el('div',{class:'qa-q'},['–í–æ–ø—Ä–æ—Å: ', q]), el('div',{class:'qa-a', html:a}) ]));
    });
    qaLoadedFor = topicId;
  } catch {
    box.innerHTML = '<div class="empty" style="color:#b91c1c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤.</div>';
  }
}

/* ============ Comments / Likes / Share ============ */
async function loadComments(topicId){
  const box = document.getElementById('comments');
  box.innerHTML = '<div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  try{
    const data = await fetchJSON(`${API_BASE}?action=comments&topicId=${encodeURIComponent(topicId)}`);
    box.innerHTML = '';
    (data.comments||[]).forEach(c=>{
      box.append(el('div',{class:'comment'},[ el('div',{},[c.text]), el('small',{},[`${c.name||'–°—Ç—É–¥–µ–Ω—Ç'} ¬∑ ${formatDT(c.ts)}`]) ]));
    });
  }catch{
    box.innerHTML = '<div class="empty" style="color:#b91c1c">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</div>';
  }
}
function formatDT(v){ try{ const d=new Date(v); return d.toLocaleString(undefined,{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return ''} }
function updateLikeUiDisabled(disabled){
  const btn = document.getElementById('likeBtn');
  btn.classList.toggle('disabled', !!disabled); btn.disabled = !!disabled;
}
async function refreshLikes(topicId){
  try{ const data = await fetchJSON(`${API_BASE}?action=reactions&topicId=${encodeURIComponent(topicId)}`);
       document.getElementById('likeCount').textContent = (data.reactions && data.reactions.likes) || 0; }catch{}
}
async function likeCurrent(){
  if (!CURRENT) return;
  if (localStorage.getItem('liked_'+CURRENT.id)) { updateLikeUiDisabled(true); return; }
  const fd = new FormData();
  fd.append('action','like'); fd.append('topicId', CURRENT.id);
  fd.append('token', (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2))+Date.now());
  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    if (json.ok || json.already){
      document.getElementById('likeCount').textContent = (json.likes || 0);
      localStorage.setItem('liked_'+CURRENT.id, '1'); updateLikeUiDisabled(true);
    }
  }catch{}
}
async function shareCurrent(){
  if (!CURRENT) return;
  const title = CURRENT.title;
  const url = location.href.split('#')[0] + '#topic=' + encodeURIComponent(CURRENT.id);
  const text = '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–µ–º—É: ' + title;
  if (navigator.share){ try{ await navigator.share({ title, text, url }); }catch{} }
  else { try{ await navigator.clipboard.writeText(url); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: ' + url); } catch{ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É:', url); } }
}

/* ============ AI chat ============ */
function setAiBusy(busy, msg){
  const btn = document.getElementById('askBtn'); const st = document.getElementById('aiStatus');
  btn.classList.toggle('disabled', !!busy); btn.disabled = !!busy;
  st.textContent = msg || (busy ? '–ì–æ—Ç–æ–≤–∏–º –æ—Ç–≤–µ—Ç‚Ä¶' : '');
}
function showAiAnswer(htmlArray){
  const box = document.getElementById('aiAnswer'); const body = document.getElementById('aiAnswerBody');
  body.innerHTML = '';
  htmlArray.forEach((ans, i)=>{ const wrap=document.createElement('div'); wrap.className='ai-variant'; wrap.innerHTML=`<div style="font-weight:700;margin-bottom:4px;color:#0B2E5E">–í–∞—Ä–∏–∞–Ω—Ç ${i+1}:</div>${ans}`; body.appendChild(wrap); });
  box.hidden = false; box.scrollIntoView({ behavior:'smooth', block:'start' });
}
async function askAI(){
  if (!CURRENT) return;
  const qEl = document.getElementById('aiQuestion'); const q = qEl.value.trim(); if(!q) return;
  setAiBusy(true, '–§–æ—Ä–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç‚Ä¶');
  const fd = new FormData(); fd.append('action','ask'); fd.append('topicId', CURRENT.id); fd.append('question', q);
  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd }); const json = await res.json();
    if (json.ok){
      const arr = Array.isArray(json.answers) ? json.answers.map(a=>mdToHtml(String(a||'').trim()))
                                              : [ mdToHtml(String(json.answer||'').trim()) ];
      showAiAnswer(arr); setAiBusy(false,'–ì–æ—Ç–æ–≤–æ'); qEl.value=''; await loadQA(CURRENT.id);
    } else setAiBusy(false, '–û—à–∏–±–∫–∞: '+(json.error||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
  }catch{ setAiBusy(false, '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
}
document.getElementById('aiForm').addEventListener('submit', (e)=>{ e.preventDefault(); askAI(); });
document.getElementById('likeBtn').addEventListener('click', likeCurrent);
document.getElementById('shareBtn').addEventListener('click', shareCurrent);

/* ============ Tabs ============ */
let ACTIVE_TAB = 'material';
function showTab(tab){
  ACTIVE_TAB = tab;
  document.getElementById('tab-material').classList.toggle('active', tab==='material');
  document.getElementById('tab-cards').classList.toggle('active', tab==='cards');
  ['block-video','block-desc','block-ai','block-social'].forEach(id=> document.getElementById(id).hidden = (tab!=='material'));
  document.getElementById('block-cards').hidden = (tab!=='cards');
  if (tab==='cards' && CURRENT){ ensureCardsLoaded(CURRENT.id); }
}
document.getElementById('tab-material').addEventListener('click', ()=>showTab('material'));
document.getElementById('tab-cards').addEventListener('click', ()=>showTab('cards'));

/* ============ CARDS ============ */
let CARDS = [];
let orderIdx = [];
let ci = 0;
let flippedCard = false;
const openedSet = new Set();

const CELS = {
  box: document.getElementById('cardBox'),
  qTitle: document.getElementById('qTitle'),
  qText: document.getElementById('qText'),
  aText: document.getElementById('aText'),
  counter: document.getElementById('cardsCounter'),
  bar: document.getElementById('cardsBar'),
  status: document.getElementById('cardsStatus'),
  btnPrev: document.getElementById('prevCard'),
  btnNext: document.getElementById('nextCard'),
  btnGen: document.getElementById('genCards'),
  congrats: document.getElementById('cardsCongrats'),
  overlay: document.getElementById('genOverlay'),
};

function showGenOverlay(v){ CELS.overlay.classList.toggle('show', !!v); }

function setCardFlipped(v){
  flippedCard = v;
  CELS.box.classList.toggle('is-flipped', flippedCard);
  if (flippedCard && CARDS.length){
    const k = orderIdx[ci];
    openedSet.add(k);
    checkCompletion();
    persistOpened();
  }
}
function checkCompletion(){
  if (CARDS.length && openedSet.size === CARDS.length){
    CELS.congrats.classList.add('show');
  }
}
function resetCompletion(){
  openedSet.clear();
  CELS.congrats.classList.remove('show');
}
function renderCard(){
  if (!CARDS.length){
    CELS.qTitle.textContent = '–í–æ–ø—Ä–æ—Å';
    CELS.qText.textContent = '–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"';
    CELS.aText.textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.';
    CELS.counter.textContent = '0/0';
    CELS.bar.style.width = '0%';
    resetCompletion();
    return;
  }
  const k = orderIdx[ci];
  const item = CARDS[k];
  CELS.qTitle.textContent = `–í–æ–ø—Ä–æ—Å ${ci+1}`;
  CELS.qText.textContent = item.q;
  CELS.aText.textContent = item.a;
  CELS.counter.textContent = `${ci+1}/${CARDS.length}`;
  CELS.bar.style.width = `${((ci+1)/CARDS.length)*100}%`;
}
function shuffleOrder(){
  orderIdx = [...CARDS.keys()];
  for (let j=orderIdx.length-1;j>0;j--){
    const k = Math.floor(Math.random()*(j+1));
    [orderIdx[j], orderIdx[k]] = [orderIdx[k], orderIdx[j]];
  }
  ci = 0;
}

/* –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
function cardsKey(){ return 'cards_'+(CURRENT?CURRENT.id:''); }
function openedKey(){ return 'cards_opened_'+(CURRENT?CURRENT.id:''); }
function persistCards(){ try{ localStorage.setItem(cardsKey(), JSON.stringify(CARDS)); }catch{} }
function persistOpened(){ try{ localStorage.setItem(openedKey(), JSON.stringify([...openedSet])); }catch{} }
function tryLoadLocalCards(){
  try{
    const raw = localStorage.getItem(cardsKey());
    if (!raw) return false;
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr) || !arr.length) return false;
    CARDS = arr.map(x=>({q:String(x.q||''), a:String(x.a||'')}));
    const op = JSON.parse(localStorage.getItem(openedKey())||'[]');
    openedSet.clear(); op.forEach(i=>openedSet.add(Number(i)));
    shuffleOrder(); setCardFlipped(false); renderCard(); checkCompletion();
    return true;
  }catch{ return false; }
}

/* –µ—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª –±–µ–∫–µ–Ω–¥ /flashcards, —Ç—É—Ç ¬´–º—è–≥–∫–æ¬ª –ø—Ä–æ–±—É–µ–º, –Ω–æ –±–µ–∑ –Ω–µ–≥–æ –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∏–º */
async function loadCards(topicId){
  try{
    CELS.status.textContent = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏‚Ä¶';
    const data = await fetchJSON(`${API_BASE}?action=flashcards&topicId=${encodeURIComponent(topicId)}`);
    const items = (data && data.cards) || [];
    CARDS = items.filter(x=>x && x.q && x.a).map(x=>({q:String(x.q), a:String(x.a)}));
    shuffleOrder(); setCardFlipped(false); resetCompletion(); renderCard();
    CELS.status.textContent = CARDS.length ? '' : '';
    persistCards(); persistOpened();
  }catch{
    CELS.status.textContent = ''; // –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑–≤–∞–µ–º ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
  }
}

/* —É—Å–∏–ª–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ */
function extractJsonArray(text){
  if (!text) return [];
  let t = String(text).trim();

  // —É–±–µ—Ä—ë–º –∫–æ–¥-–±–ª–æ–∫–∏ –∏ –ª–∏—à–Ω–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
  t = t.replace(/```(?:json)?/gi,'```');
  if (/```/.test(t)){
    const m = t.match(/```([\s\S]*?)```/);
    if (m) t = m[1];
  }

  // –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π JSON-–º–∞—Å—Å–∏–≤
  let m = t.match(/\[[\s\S]*\]/);
  if (m) t = m[0];

  // –ø–æ—á–∏–Ω–∫–∞ —Ç–∏–ø–∏—á–Ω—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
  t = t.replace(/[‚Äú‚Äù]/g,'"').replace(/[‚Äò‚Äô]/g,"'");
  t = t.replace(/,\s*]/g,']').replace(/,\s*}/g,'}');

  try{
    const arr = JSON.parse(t);
    if (Array.isArray(arr)) return arr;
    return [];
  }catch{
    return [];
  }
}

async function generateCards(topic){
  const t = topic || CURRENT; if (!t) return;
  CELS.status.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã‚Ä¶';
  CELS.btnGen.classList.add('disabled'); CELS.btnGen.disabled = true;
  showGenOverlay(true);

  const prompt = [
    '–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –†–û–í–ù–û 12 –∫–∞—Ä—Ç–æ—á–µ–∫ ¬´–≤–æ–ø—Ä–æ—Å‚Äì–æ—Ç–≤–µ—Ç¬ª –ø–æ —Ç–µ–º–µ –Ω–∏–∂–µ.',
    '–í–∞–∂–Ω–æ:',
    '- –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –∫–æ—Ä–æ—Ç–∫–∏–π –∏ —á—ë—Ç–∫–∏–π (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏;',
    '- –æ—Ç–≤–µ—Ç —Ç–æ—á–Ω—ã–π –∏ —ë–º–∫–∏–π (1‚Äì3 –ø—É–Ω–∫—Ç–∞ —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è);',
    '- –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, –ë–ï–ó Markdown, –ë–ï–ó –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤;',
    '- –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç ‚Äî —á–∏—Å—Ç—ã–π JSON-–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞ [{"q":"–í–æ–ø—Ä–æ—Å?","a":"–û—Ç–≤–µ—Ç."}];',
    '- —è–∑—ã–∫ —Ä—É—Åc–∫–∏–π.',
    '',
    '–¢–µ–º–∞: '+t.title,
    '–û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å Markdown, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –ø–æ —Å—É—Ç–∏, –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):',
    (t.description || '').slice(0, 4000)
  ].join('\n');

  try{
const fd = new FormData();
fd.append('action','ask');
fd.append('topicId', t.id);
fd.append('question', prompt);
fd.append('channel', 'cards'); 

    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();

    const raw = Array.isArray(json.answers) ? json.answers.join('\n') : (json.answer || '');
    let arr = extractJsonArray(raw);

    if (!arr.length){
      // –∑–∞–ø–∞—Å–Ω–æ–π —à–∞–Ω—Å: –∏–Ω–æ–≥–¥–∞ –º–æ–¥–µ–ª—å –¥–∞—ë—Ç –ø–æ –æ–¥–Ω–æ–π –ø–∞—Ä–µ –≤ —Å—Ç—Ä–æ–∫–µ ‚Äî —Å–æ–±–µ—Ä—ë–º –≤—Ä—É—á–Ω—É—é
      const pairs = [...raw.matchAll(/"q"\s*:\s*"([^"]+)"\s*,\s*"a"\s*:\s*"([^"]+)"/g)].map(m=>({q:m[1],a:m[2]}));
      if (pairs.length) arr = pairs;
    }
    CARDS = arr.filter(x=>x && x.q && x.a).map(x=>({q:String(x.q), a:String(x.a)}));

    if (!CARDS.length) throw new Error('empty');

    shuffleOrder(); setCardFlipped(false); resetCompletion(); renderCard();
    CELS.status.textContent = `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${CARDS.length} –∫–∞—Ä—Ç–æ—á–µ–∫`;
    persistCards(); persistOpened();
  }catch(e){
    console.error(e);
    CELS.status.textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –µ—â—ë —Ä–∞–∑.';
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
  }finally{
    CELS.btnGen.classList.remove('disabled'); CELS.btnGen.disabled = false;
    showGenOverlay(false);
  }
}

let cardsLoadedFor = null;
async function ensureCardsLoaded(topicId){
  if (cardsLoadedFor === topicId) return;
  // 1) –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–µ—à
  if (!tryLoadLocalCards()){
    // 2) –ø—Ä–æ–±—É–µ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) –±—ç–∫–µ–Ω–¥
    await loadCards(topicId);
  }
  cardsLoadedFor = topicId;
}

function prevCard(){ if (!CARDS.length) return; ci = (ci - 1 + CARDS.length) % CARDS.length; setCardFlipped(false); renderCard(); }
function nextCard(){ if (!CARDS.length) return; ci = (ci + 1) % CARDS.length; setCardFlipped(false); renderCard(); }
function flipCard(){ setCardFlipped(!flippedCard); }

document.getElementById('cardBox').addEventListener('click', flipCard);
document.getElementById('prevCard').addEventListener('click', prevCard);
document.getElementById('nextCard').addEventListener('click', nextCard);
document.getElementById('genCards').addEventListener('click', ()=>generateCards(CURRENT));
document.addEventListener('keydown', (e)=>{
  if (document.getElementById('block-cards').hidden) return;
  if (e.key===' ') { e.preventDefault(); flipCard(); }
  if (e.key==='ArrowRight') nextCard();
  if (e.key==='ArrowLeft') prevCard();
});

/* ============ Topic select & Boot ============ */
async function selectTopic(id){
  const t = TOPICS.find(x=>String(x.id)===String(id)); if (!t) return;
  CURRENT = t;

  document.getElementById('topicTitle').textContent = t.title;
  renderPlayer(t.embed);
  document.getElementById('block-video').hidden = false;

  const desc = document.getElementById('desc');
  desc.innerHTML = t.descriptionHtml ? t.descriptionHtml : mdToHtml(t.description || '');
  document.getElementById('block-desc').hidden = false;

  document.getElementById('aiAnswer').hidden = true;
  document.getElementById('aiStatus').textContent = '';
  document.getElementById('block-ai').hidden = false;

  document.getElementById('block-social').hidden = false;

  await loadComments(id);
  await refreshLikes(id);
  updateLikeUiDisabled( !!localStorage.getItem('liked_'+id) );

  qaLoadedFor = null;
  document.getElementById('qaBox').innerHTML = '<div class="empty"><div class="spinner spinner--sm" aria-hidden="true"></div>–ò—â–µ–º –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –ò–ò‚Ä¶</div>';
  await loadQA(id);

  history.replaceState(null, '', '#topic=' + encodeURIComponent(id));

  // –∫–∞—Ä—Ç–æ—á–∫–∏
  cardsLoadedFor = null; CARDS = []; ci = 0; setCardFlipped(false); resetCompletion(); renderCard();
  if (ACTIVE_TAB==='cards') ensureCardsLoaded(id);
}

async function boot(){
  try{
    const data = await fetchJSON(`${API_BASE}?action=topics`);
    TOPICS = data.topics || [];
    if (!TOPICS.length){ hideSplash(); return; }
    buildSelect(TOPICS);
    const hash = new URL(location.href).hash;
    const m = hash.match(/topic=([^&]+)/);
    const initialId = m ? decodeURIComponent(m[1]) : TOPICS[0].id;
    document.getElementById('topicSelect').value = initialId;
    await selectTopic(initialId);
    hideSplash();
  }catch(err){ console.error(err); hideSplash(); }
}

/* events */
document.getElementById('commentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if (!CURRENT) return;
  const msg = document.getElementById('commentMsg'); msg.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';
  const fd = new FormData();
  fd.append('action','addComment'); fd.append('topicId', CURRENT.id);
  fd.append('name', e.target.name.value.trim()); fd.append('text', e.target.text.value.trim());
  try{
    const res = await fetch(API_BASE, { method:'POST', body: fd });
    const json = await res.json();
    msg.textContent = json.ok ? '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω ‚úî' : '–û—à–∏–±–∫–∞: ' + (json.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
    if (json.ok){ e.target.reset(); await loadComments(CURRENT.id); }
  }catch{ msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; }
});

document.getElementById('tab-material').addEventListener('click', ()=>showTab('material'));
document.getElementById('tab-cards').addEventListener('click', ()=>showTab('cards'));

showTab('material');
boot();
</script>
</body>
</html>
